<mxfile host="app.diagrams.net" agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Safari/537.36" version="26.0.16" pages="2">
  <diagram name="模块" id="URdqgQ9ywC9-zDl-EaOu">
    <mxGraphModel dx="1434" dy="746" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="feOOVioLAqPZcGWc1d9--1" value="ActualPositionDB" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="40" width="160" height="120" as="geometry" />
        </mxCell>
        <mxCell id="feOOVioLAqPZcGWc1d9--2" value="DBConnectionPool&lt;div&gt;//&amp;nbsp;链接 SQL 数据库&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="280" y="40" width="160" height="120" as="geometry" />
        </mxCell>
        <mxCell id="feOOVioLAqPZcGWc1d9--4" value="" style="rhombus;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;" vertex="1" parent="1">
          <mxGeometry x="160" y="130" width="30" height="30" as="geometry" />
        </mxCell>
        <mxCell id="feOOVioLAqPZcGWc1d9--3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="feOOVioLAqPZcGWc1d9--4" target="feOOVioLAqPZcGWc1d9--2">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="OAtjJLmcrKw9Vd1Cq_iK" name="流程">
    <mxGraphModel dx="1647" dy="1049" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="0" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-12" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;fontColor=#333333;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="-360" y="-260" width="800" height="1060" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-10" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="i-nkXKOmJGmnzbzkcPUM-3" target="i-nkXKOmJGmnzbzkcPUM-6">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-3" value="Plugin&amp;nbsp;构造函数&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;调用 InitConfig( )&amp;nbsp;进行模块配置初始化&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;" vertex="1" parent="1">
          <mxGeometry x="40" y="-120" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="i-nkXKOmJGmnzbzkcPUM-4" target="i-nkXKOmJGmnzbzkcPUM-3">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-4" value="外部框架：create_plugin.h&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;创建 Plugin&amp;nbsp;对象&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;" vertex="1" parent="1">
          <mxGeometry x="40" y="-240" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-6" value="&lt;div&gt;InitConfig( )&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1.&amp;nbsp;初始化 IIMgr，用于管理股票名称到内部整型 index&amp;nbsp;的单例模块，维护了正反管理两者映射的数据结构，使用外部 InstrumentIndex.csv&amp;nbsp;文件进行初始化&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;2.&amp;nbsp;初始化 DIMgr，用于管理交易日到&amp;nbsp;index&amp;nbsp;的单例模块，也是维护了正反&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;查询&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;数据结构使用 DateIndex.csv&amp;nbsp;进行初始化&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.&amp;nbsp;解析&amp;nbsp;projectconfig&amp;nbsp;json&amp;nbsp;文件&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.1&amp;nbsp;设置是否 replay&amp;nbsp;模式&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.2&amp;nbsp;设置是否&amp;nbsp;debug&amp;nbsp;模式&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.3&amp;nbsp;从配置得到 csv&amp;nbsp;输出路径，初始化 CSVMgr，用于以&amp;nbsp;csv&amp;nbsp;形式进行数据记录的单例模块&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.4&amp;nbsp;从配置得到&amp;nbsp;signal_address&amp;nbsp;信号地址，本地保存&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.5&amp;nbsp;从配置&amp;nbsp;black_white_database&amp;nbsp;字段得到黑白名单数据库字段，得到dsn，然后用于初始化 BlackWhiteList&amp;nbsp;单例对象。这个对象从对应的黑白名单数据库中获取到一系列股票和对应的bool字段，标识该股票是否处于黑白名单中&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.6&amp;nbsp;从配置&amp;nbsp;realtime_signal_detabase&amp;nbsp;字段得到信号数据库的 dsn&amp;nbsp;用于初始化 RealTimeSignalDB&amp;nbsp;单例对象。&amp;nbsp;这个对象应该是用于初始化当日信号权重（读取昨日最后一个截面权重）的。&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.7&amp;nbsp;从配置 preposition_database&amp;nbsp;字段得到昨仓数据库的 dsn，用于初始化 ActualPostionDB&amp;nbsp;对象，这个对象用于从数据库中获取昨日各产品、各个股票持仓&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.8&amp;nbsp;从配置&amp;nbsp;signal_configs&amp;nbsp;字段获取各个策略的配置，用于初始化 StrategyMgr，这个对象主要维护了各个&amp;nbsp;策略的更新时间点、以及是不是日频策略等信息（如果策略配置的时间点是盘前，那么就认为这个策略是日频策略）&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.9&amp;nbsp;使用刚才解析的&amp;nbsp;signal_address&amp;nbsp;更新 SignalReceiver。&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;SignalReceiver&amp;nbsp;是一个 AnyReceiverSpi，用于接收信号，这个模块功能比较丰富，待进一步细看补充。&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;4.&amp;nbsp;解析&amp;nbsp;product&amp;nbsp;config&amp;nbsp;json 文件&lt;/div&gt;&lt;div&gt;4.1&amp;nbsp;从配置&amp;nbsp;default_product_config&amp;nbsp;字段读取默认的产品配置，用于初始化 DefaultProductConfig&amp;nbsp;单例对象。&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;DefaultProductConfig&amp;nbsp;对象包含对应的大策略名称，对标的对冲指数(?)，杠杆、各个子策略的新旧权重，策略的调仓时间等参数&lt;/span&gt;&lt;/div&gt;&lt;div&gt;4.2&amp;nbsp;从配置&amp;nbsp;product&amp;nbsp;configs&amp;nbsp;字段读取产品配置，用于初始化 PositionMgr&amp;nbsp;单例对象。这个对象维护了&amp;nbsp;hash_products_&amp;nbsp;对象，包含了（product id+unistrategy id）到 Product&amp;nbsp;对象之间的映射。在初始化阶段，由&amp;nbsp;json&amp;nbsp;解析出的 config&amp;nbsp;配置去初始化 Product，然后存放到&amp;nbsp;hash_products_&amp;nbsp;数据中。&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;5.&amp;nbsp;初始化 MD 行情模块，MD 对象设置了读取行情的handler（应该类似于shm&amp;nbsp;meta元数据），设置Ti1的回调函数。如果当前是&amp;nbsp;replay&amp;nbsp;模式，那么直接启动 MD.start(0)。&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="40" width="360" height="750" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-7" value="所以黑白名单在具体业务层面具体对应什么含义？为什么不区分黑名单和白名单？" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="-160" y="340" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-8" value="&lt;span style=&quot;text-align: left;&quot;&gt;signal_address&amp;nbsp;待细看&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="-160" y="430" width="160" height="50" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-9" value="&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;我们&amp;nbsp;product&amp;nbsp;和大策略是一个概念吗？换句话说product&amp;nbsp;和大策略是一一对应吗？&lt;/span&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="-160" y="500" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-13" value="&lt;font style=&quot;font-size: 16px;&quot;&gt;初始化流程&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-330" y="-250" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="i-nkXKOmJGmnzbzkcPUM-14" target="i-nkXKOmJGmnzbzkcPUM-15">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-14" value="收到行情" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="840" width="360" height="40" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-18" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="i-nkXKOmJGmnzbzkcPUM-15" target="i-nkXKOmJGmnzbzkcPUM-16">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-15" value="Plugin::Action&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;实盘（非replay场景）：&lt;div&gt;调用 MD&amp;nbsp;模块的 MDCallback()&amp;nbsp;方法&lt;/div&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="40" y="920" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-21" value="ti1&amp;nbsp;发生更新时" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="i-nkXKOmJGmnzbzkcPUM-16" target="i-nkXKOmJGmnzbzkcPUM-20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-16" value="MD::MDCallback&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1. 解析行情结构&lt;/div&gt;&lt;div&gt;2.&amp;nbsp;更新当前最新的接收行情时间戳&amp;nbsp;latest_timestamp_&lt;/div&gt;&lt;div&gt;3.&amp;nbsp;从当前行情时间得到对应的&amp;nbsp;ti1&lt;/div&gt;&lt;div&gt;4.&amp;nbsp;从当前行情取出&amp;nbsp;lastprice，判断价格是否有效&lt;/div&gt;&lt;div&gt;5.&amp;nbsp;更新对应股票对应 ti1 的价格到 MD::index_prices_ 中&lt;/div&gt;&lt;div&gt;6.&amp;nbsp;得到对应&amp;nbsp;stock&amp;nbsp;的&amp;nbsp;ii，更新 ii 的价格到 MD::ti1_prices 中&lt;/div&gt;&lt;div&gt;7.&amp;nbsp;判断当前时点对应的&amp;nbsp;ti1&amp;nbsp;发生变化，触发&amp;nbsp;ti1&amp;nbsp;回调函数 ti1callback_&lt;/div&gt;&lt;div&gt;8.&amp;nbsp;得到当前时点对应的&amp;nbsp;ti5&lt;/div&gt;&lt;div&gt;9.&amp;nbsp;更新&amp;nbsp;ii&amp;nbsp;的价格到 MD::ti5_prices_&amp;nbsp;中&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="40" y="1040" width="360" height="200" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-19" value="每个&amp;nbsp;tick&amp;nbsp;来都会去计算当前timestamp所属的 ti1 并更新其信息（stock&amp;nbsp;价格，ii&amp;nbsp;价格，timestamp等），但是只有当前&amp;nbsp;ti1&amp;nbsp;发生更新时才会触发&amp;nbsp;ti1callback&amp;nbsp;回调函数；ti5&amp;nbsp;同理" style="rounded=0;whiteSpace=wrap;html=1;align=left;" vertex="1" parent="1">
          <mxGeometry x="-160" y="1080" width="160" height="120" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-20" value="&lt;div&gt;on_minute1&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;调用 PositionMgr::OnMinute1&amp;nbsp;触发仓位模块的1分钟回调函数&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="40" y="1320" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-22" value="&lt;div&gt;PositionMgr::OnMinute1&lt;/div&gt;&lt;div&gt;使用当前传入的 ti，通过 StrategyMgr 找到这个 ti&amp;nbsp;对应的需要更新的策略集合，如果是空的，什么都不做&lt;/div&gt;&lt;div&gt;如果集合不是空的（即当前&amp;nbsp;ti&amp;nbsp;有策略需要更新），那么就通过&amp;nbsp;hash_products_&amp;nbsp;去遍历产品，将当前&amp;nbsp;ti&amp;nbsp;放到该产品的 Product::ti_queue 中。&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="40" y="1440" width="360" height="120" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-23" value="注意：此处的&amp;nbsp; StrategyMgr&amp;nbsp; 查找出的 strategy&amp;nbsp;集合只是拿来简单判断流程，并没有向下进一步传入，当需要更新时，真正做的事情是将该&amp;nbsp;ti&amp;nbsp;放到了各个产品的&amp;nbsp;ti_queue&amp;nbsp;中异步处理" style="rounded=0;whiteSpace=wrap;html=1;align=left;" vertex="1" parent="1">
          <mxGeometry x="-160" y="1440" width="160" height="120" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
