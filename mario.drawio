<mxfile host="app.diagrams.net" agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Safari/537.36" version="26.0.16" pages="2">
  <diagram name="模块" id="URdqgQ9ywC9-zDl-EaOu">
    <mxGraphModel dx="1434" dy="746" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="feOOVioLAqPZcGWc1d9--1" value="ActualPositionDB" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="40" width="160" height="120" as="geometry" />
        </mxCell>
        <mxCell id="feOOVioLAqPZcGWc1d9--2" value="DBConnectionPool&lt;div&gt;//&amp;nbsp;链接 SQL 数据库&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="280" y="40" width="160" height="120" as="geometry" />
        </mxCell>
        <mxCell id="feOOVioLAqPZcGWc1d9--4" value="" style="rhombus;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;" vertex="1" parent="1">
          <mxGeometry x="160" y="130" width="30" height="30" as="geometry" />
        </mxCell>
        <mxCell id="feOOVioLAqPZcGWc1d9--3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="feOOVioLAqPZcGWc1d9--4" target="feOOVioLAqPZcGWc1d9--2">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="OAtjJLmcrKw9Vd1Cq_iK" name="流程">
    <mxGraphModel dx="2059" dy="1062" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="0" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-27" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;fontColor=#333333;strokeColor=#666666;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="-440" y="2560" width="800" height="800" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-12" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;fontColor=#333333;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="-360" y="-280" width="800" height="1080" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-10" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" edge="1" parent="1" source="i-nkXKOmJGmnzbzkcPUM-3" target="i-nkXKOmJGmnzbzkcPUM-6">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-3" value="Plugin&amp;nbsp;构造函数&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;调用 InitConfig( )&amp;nbsp;进行模块配置初始化&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="40" y="-120" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" edge="1" parent="1" source="i-nkXKOmJGmnzbzkcPUM-4" target="i-nkXKOmJGmnzbzkcPUM-3">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-4" value="外部框架：create_plugin.h&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;创建 Plugin&amp;nbsp;对象&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="40" y="-240" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-6" value="&lt;div&gt;InitConfig( )&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1.&amp;nbsp;初始化 IIMgr，用于管理股票名称到内部整型 index&amp;nbsp;的单例模块，维护了正反管理两者映射的数据结构，使用外部 InstrumentIndex.csv&amp;nbsp;文件进行初始化&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;2.&amp;nbsp;初始化 DIMgr，用于管理交易日到&amp;nbsp;index&amp;nbsp;的单例模块，也是维护了正反&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;查询&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;数据结构，使用 DateIndex.csv&amp;nbsp;进行初始化&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.&amp;nbsp;解析&amp;nbsp;projectconfig&amp;nbsp;json&amp;nbsp;文件&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.1&amp;nbsp;设置是否 replay&amp;nbsp;模式&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.2&amp;nbsp;设置是否&amp;nbsp;debug&amp;nbsp;模式&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.3&amp;nbsp;从配置得到 csv&amp;nbsp;输出路径，初始化 CSVMgr，用于以&amp;nbsp;csv&amp;nbsp;形式进行数据记录的单例模块&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.4&amp;nbsp;从配置得到&amp;nbsp;signal_address&amp;nbsp;信号地址，本地保存&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.5&amp;nbsp;从配置&amp;nbsp;black_white_database&amp;nbsp;字段得到黑白名单数据库字段，得到dsn，然后用于初始化 BlackWhiteList&amp;nbsp;单例对象。这个对象从对应的黑白名单数据库中获取到一系列股票和对应的bool字段，标识该股票是否处于黑白名单中&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.6&amp;nbsp;从配置&amp;nbsp;realtime_signal_detabase&amp;nbsp;字段得到信号数据库的 dsn&amp;nbsp;用于初始化 RealTimeSignalDB&amp;nbsp;单例对象。&amp;nbsp;这个对象应该是用于初始化当日信号权重（读取昨日最后一个截面权重）的。&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.7&amp;nbsp;从配置 preposition_database&amp;nbsp;字段得到昨仓数据库的 dsn，用于初始化 ActualPostionDB&amp;nbsp;对象，这个对象用于从数据库中获取昨日各产品、各个股票持仓&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.8&amp;nbsp;从配置&amp;nbsp;signal_configs&amp;nbsp;字段获取各个策略的配置，用于初始化 StrategyMgr，这个对象主要维护了各个&amp;nbsp;策略的更新时间点、以及是不是日频策略等信息（如果策略配置的时间点是盘前，那么就认为这个策略是日频策略）&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.9&amp;nbsp;使用刚才解析的&amp;nbsp;signal_address&amp;nbsp;更新 SignalReceiver。&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;SignalReceiver&amp;nbsp;是一个 AnyReceiverSpi，用于接收信号，这个模块功能比较丰富，待进一步细看补充。&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;4.&amp;nbsp;解析&amp;nbsp;product&amp;nbsp;config&amp;nbsp;json 文件&lt;/div&gt;&lt;div&gt;4.1&amp;nbsp;从配置&amp;nbsp;default_product_config&amp;nbsp;字段读取默认的产品配置，用于初始化 DefaultProductConfig&amp;nbsp;单例对象。&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;DefaultProductConfig&amp;nbsp;对象包含对应的大策略名称，对标的对冲指数(?)，杠杆、各个子策略的新旧权重，策略的调仓时间等参数&lt;/span&gt;&lt;/div&gt;&lt;div&gt;4.2&amp;nbsp;从配置&amp;nbsp;product&amp;nbsp;configs&amp;nbsp;字段读取产品配置，用于初始化 PositionMgr&amp;nbsp;单例对象。这个对象维护了&amp;nbsp;hash_products_&amp;nbsp;对象，包含了（product id+unistrategy id）到 Product&amp;nbsp;对象之间的映射。在初始化阶段，由&amp;nbsp;json&amp;nbsp;解析出的 config&amp;nbsp;配置去初始化 Product，然后存放到&amp;nbsp;hash_products_&amp;nbsp;数据中。&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;5.&amp;nbsp;初始化 MD 行情模块，MD 对象设置了读取行情的handler（应该类似于shm&amp;nbsp;meta元数据），设置Ti1的回调函数。如果当前是&amp;nbsp;replay&amp;nbsp;模式，那么直接启动 MD.start(0)。&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="40" width="360" height="750" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-7" value="所以黑白名单在具体业务层面具体对应什么含义？为什么不区分黑名单和白名单？" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="-160" y="340" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-8" value="&lt;span style=&quot;text-align: left;&quot;&gt;signal_address&amp;nbsp;待细看&lt;/span&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="-160" y="430" width="160" height="50" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-9" value="&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;我们&amp;nbsp;product&amp;nbsp;和大策略是一个概念吗？换句话说product&amp;nbsp;和大策略是一一对应吗？&lt;/span&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="-160" y="500" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-13" value="&lt;font style=&quot;font-size: 16px;&quot;&gt;初始化流程&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-330" y="-250" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" edge="1" parent="1" source="i-nkXKOmJGmnzbzkcPUM-14" target="i-nkXKOmJGmnzbzkcPUM-15">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-14" value="收到行情" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-40" y="2600" width="360" height="40" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-18" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" edge="1" parent="1" source="i-nkXKOmJGmnzbzkcPUM-15" target="i-nkXKOmJGmnzbzkcPUM-16">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-15" value="Plugin::Action&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;实盘（非replay场景）：&lt;div&gt;调用 MD&amp;nbsp;模块的 MDCallback()&amp;nbsp;方法&lt;/div&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-40" y="2680" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-21" value="ti1&amp;nbsp;发生更新时" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" edge="1" parent="1" source="i-nkXKOmJGmnzbzkcPUM-16" target="i-nkXKOmJGmnzbzkcPUM-20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-16" value="MD::MDCallback&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1. 解析行情结构&lt;/div&gt;&lt;div&gt;2.&amp;nbsp;更新当前最新的接收行情时间戳&amp;nbsp;latest_timestamp_&lt;/div&gt;&lt;div&gt;3.&amp;nbsp;从当前行情时间得到对应的&amp;nbsp;ti1&lt;/div&gt;&lt;div&gt;4.&amp;nbsp;从当前行情取出&amp;nbsp;lastprice，判断价格是否有效&lt;/div&gt;&lt;div&gt;5.&amp;nbsp;更新对应股票对应 ti1 的价格到 MD::index_prices_ 中&lt;/div&gt;&lt;div&gt;6.&amp;nbsp;得到对应&amp;nbsp;stock&amp;nbsp;的&amp;nbsp;ii，更新 ii 的价格到 MD::ti1_prices 中&lt;/div&gt;&lt;div&gt;7.&amp;nbsp;判断当前时点对应的&amp;nbsp;ti1&amp;nbsp;发生变化，触发&amp;nbsp;ti1&amp;nbsp;回调函数 ti1callback_&lt;/div&gt;&lt;div&gt;8.&amp;nbsp;得到当前时点对应的&amp;nbsp;ti5&lt;/div&gt;&lt;div&gt;9.&amp;nbsp;更新&amp;nbsp;ii&amp;nbsp;的价格到 MD::ti5_prices_&amp;nbsp;中&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-40" y="2800" width="360" height="200" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-19" value="每个&amp;nbsp;tick&amp;nbsp;来都会去计算当前timestamp所属的 ti1 并更新其信息（stock&amp;nbsp;价格，ii&amp;nbsp;价格，timestamp等），但是只有当前&amp;nbsp;ti1&amp;nbsp;发生更新时才会触发&amp;nbsp;ti1callback&amp;nbsp;回调函数；ti5&amp;nbsp;同理" style="rounded=0;whiteSpace=wrap;html=1;align=left;" vertex="1" parent="1">
          <mxGeometry x="-240" y="2840" width="160" height="120" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-24" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" edge="1" parent="1" source="i-nkXKOmJGmnzbzkcPUM-20" target="i-nkXKOmJGmnzbzkcPUM-22">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-20" value="&lt;div&gt;on_minute1&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;调用 PositionMgr::OnMinute1&amp;nbsp;触发仓位模块的1分钟回调函数&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-40" y="3080" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-22" value="&lt;div&gt;PositionMgr::OnMinute1&lt;/div&gt;&lt;div&gt;使用当前传入的 ti，通过 StrategyMgr 找到这个 ti&amp;nbsp;对应的需要更新的策略集合，如果是空的，什么都不做&lt;/div&gt;&lt;div&gt;如果集合不是空的（即当前&amp;nbsp;ti&amp;nbsp;有策略需要更新），那么就通过&amp;nbsp;hash_products_&amp;nbsp;去遍历产品，将当前&amp;nbsp;ti&amp;nbsp;放到该产品的 Product::ti_queue 中。（&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;Product::SyncAdjustProduct&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;）&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-40" y="3200" width="360" height="120" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-23" value="注意：此处的&amp;nbsp; StrategyMgr&amp;nbsp; 查找出的 strategy&amp;nbsp;集合只是拿来简单判断流程，并没有向下进一步传入，当需要更新时，真正做的事情是将该&amp;nbsp;ti&amp;nbsp;放到了各个产品的&amp;nbsp;ti_queue&amp;nbsp;中异步处理" style="rounded=0;whiteSpace=wrap;html=1;align=left;" vertex="1" parent="1">
          <mxGeometry x="-240" y="3200" width="160" height="120" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-28" value="&lt;span style=&quot;color: rgb(51, 51, 51); text-align: left;&quot;&gt;&lt;font style=&quot;font-size: 16px;&quot;&gt;接收行情流程&lt;/font&gt;&lt;/span&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-410" y="2580" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-29" value="IIMgr的初始化：&lt;div&gt;构造函数中读取 InstrumentIndex.csv&amp;nbsp;文件得到股票索引正反维护到 hash_code2ii&amp;nbsp;和 hash_ii2code&amp;nbsp;中&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="520" y="-280" width="680" height="80" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-30" value="DIMgr的初始化：&lt;div&gt;构造函数中读取 DateIndex.csv&amp;nbsp;文件得到日期索引正反维护到&amp;nbsp;map_date2di&amp;nbsp;和 map_di2date&amp;nbsp;中&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="520" y="-180" width="680" height="60" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-31" value="全局初始化：&lt;div&gt;config::SetReplay()&amp;nbsp;设置全局回放模式标志位&lt;/div&gt;&lt;div&gt;config::SetDebug( )&amp;nbsp;设置全局调试模式标志位&lt;/div&gt;&lt;div&gt;config::SetSignalAddr&amp;nbsp;设置全局的信号接收地址&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="520" y="-100" width="680" height="80" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-33" value="CSVMgr 初始化：&lt;div&gt;构造函数中更新&amp;nbsp;csv&amp;nbsp;输出路径到 csv_dir_&amp;nbsp;中&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="520" width="680" height="60" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-34" value="&lt;div&gt;BlackWhiteList 的初始化：&lt;/div&gt;&lt;div&gt;BlackWhiteList::Init()&amp;nbsp;&lt;/div&gt;&lt;div&gt;1.&amp;nbsp;设置&amp;nbsp;dsn&lt;/div&gt;&lt;div&gt;2.&amp;nbsp;创建数据库连接池&amp;nbsp;pool，连接池大小为2&lt;/div&gt;&lt;div&gt;3.&amp;nbsp;使用今天日期获取今天的股票黑白名单项目，放入一个 vector 中返回，然后用这个 vector&amp;nbsp;更新 hash_black_white&amp;nbsp;结构，以字典的方式维护股票名称和是否在黑白名单（valid字段）的对应关系。&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="520" y="80" width="680" height="120" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-35" value="&lt;div&gt;RealTimeSignalDB 的初始化：&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;RealTimeSignalDB::Init()&lt;/div&gt;&lt;div&gt;1.&amp;nbsp;设置&amp;nbsp;dsn&lt;/div&gt;&lt;div&gt;2.&amp;nbsp;创建数据库连接池对象&amp;nbsp;poll&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="520" y="220" width="680" height="100" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-36" value="&lt;div&gt;ActualPositionDB 的初始化：&lt;/div&gt;&lt;div&gt;ActualPositionDB::Init()&amp;nbsp;&lt;/div&gt;&lt;div&gt;1.&amp;nbsp;设置&amp;nbsp;dsn&lt;/div&gt;&lt;div&gt;2.&amp;nbsp;创建数据库连接池对象&amp;nbsp;pool&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="520" y="340" width="680" height="80" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-37" value="&lt;div&gt;StrategyMgr 的初始化：&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;StrategyMgr::&lt;/span&gt;Init()&amp;nbsp;&lt;/div&gt;&lt;div&gt;1.&amp;nbsp;解析配置文件中的&amp;nbsp;signal_configs&amp;nbsp;字段&lt;/div&gt;&lt;div&gt;2.&amp;nbsp;遍历每个&amp;nbsp;signal_configs&amp;nbsp;下元素，得到每个strategy对应的更新时间点，得到对应的&amp;nbsp;ti1&lt;/div&gt;&lt;div&gt;3.&amp;nbsp;如果这个ti1 &amp;lt;= 6，即对应盘前时间点，那么表示这个策略只是个日频策略，更新到 hash_strategy_daily_&amp;nbsp;数据结构中&lt;/div&gt;&lt;div&gt;4.&amp;nbsp;更新&amp;nbsp;map_strategy_times_，维护 strategy&amp;nbsp;下有哪些 ti&amp;nbsp;需要更新&lt;/div&gt;&lt;div&gt;5.&amp;nbsp;更新 map_ti_strategies_，维护某个&amp;nbsp;ti&amp;nbsp;下有哪些&amp;nbsp;strategy&amp;nbsp;需要更新&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="520" y="440" width="680" height="120" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-38" value="&lt;div&gt;SignalReceiver 的初始化：&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;SignalReceiver::Init()&lt;/div&gt;&lt;div&gt;1.&amp;nbsp;使用&amp;nbsp;signal_addr&amp;nbsp;初始化 sub_config_&amp;nbsp;配置，创建&amp;nbsp;api&amp;nbsp;对象，并把自己作为&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;AnyReceiverSpi&amp;nbsp;注册到 API&amp;nbsp;中&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;2.&amp;nbsp;创建信号缓存的目录 cache_dir&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;SignalReceiver::Start()&lt;/div&gt;&lt;div&gt;1.&amp;nbsp;使用&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;sub_config_&amp;nbsp; 去初始化&amp;nbsp;api&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;#&amp;nbsp;初始化后应该就意味着&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;SignalReceiver&amp;nbsp;已经启动了，后续就等待回调 OnNewSignalData 了&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="520" y="580" width="680" height="180" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-39" value="&lt;div&gt;DefaultProductConfig 的初始化：&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;DefaultProductConfig::Init()&lt;/div&gt;&lt;div&gt;1.&amp;nbsp;根据配置文件 unistrategy 设置大策略&amp;nbsp;unistrategy&amp;nbsp;的名称&lt;/div&gt;&lt;div&gt;2.&amp;nbsp;根据配置文件 hedge_name 设置对标指数&lt;/div&gt;&lt;div&gt;3.&amp;nbsp;根据配置文件 leverage 设置杠杆系数&lt;/div&gt;&lt;div&gt;4.&amp;nbsp;根据配置文件 output_if_not_ok&amp;nbsp;设置对应标志位&lt;/div&gt;&lt;div&gt;5.&amp;nbsp;根据配置文件 addition_volume&amp;nbsp;设置本地变量&lt;/div&gt;&lt;div&gt;6.&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;根据配置文件&amp;nbsp;multiply_volume&amp;nbsp;设置本地变量&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;7.&amp;nbsp;遍历配置文件中的&amp;nbsp;sub_strategies，根据&amp;nbsp;old_weight&amp;nbsp;字段，将策略的旧权重维护到 old_strategy_weights&amp;nbsp;中&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;8.&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;遍历配置文件中的&amp;nbsp;sub_strategies，根据&amp;nbsp;new_weight&amp;nbsp;字段，将策略的新权重维护到&amp;nbsp;new_strategy_weights&amp;nbsp;中&lt;/span&gt;&lt;/div&gt;&lt;div&gt;9.&amp;nbsp;分别检查旧权重和新权重的和是不是为1&lt;/div&gt;&lt;div&gt;10.&amp;nbsp;根据配置文件 adjust_weight_time&amp;nbsp;更新产品的调整权重时间到&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;DefaultProductConfig::&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;adjust_weight_time&amp;nbsp;变量&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="520" y="780" width="680" height="200" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-40" value="&lt;div&gt;PositionMgr 的初始化：&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;PositionMgr&lt;/span&gt;::Init()&lt;/div&gt;&lt;div&gt;1. 使用配置中的&amp;nbsp;product_config&amp;nbsp;初始化 ProductConfig&amp;nbsp;对象&lt;/div&gt;&lt;div&gt;2. 用&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;ProductConfig&amp;nbsp; 对象初始化 Produc&amp;nbsp;对象，然后维护到&amp;nbsp;hash_products_&amp;nbsp;数据中。hash_products_使用&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;product id+unistrategy id&amp;nbsp;和一个Product&amp;nbsp;对象进行关联&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="520" y="1000" width="680" height="120" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-41" value="&lt;div&gt;Product 的初始化：&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;使用 ProductConfig 调用 Product&lt;/span&gt;::Init() 进行初始化：&lt;/div&gt;&lt;div&gt;1. 根据&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;ProductConfig&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;中的 strategy_list 遍历当前所有策略，通过 RealTimeSignalDB，使用（策略名+日期）获取昨日持仓，以vector &amp;lt;double&amp;gt; 形式返回，以 {策略名:权重数组} 的形式放到 map_strategy_weights 中。&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;map_strategy_weights&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;维护了当前每个策略对应的权重数组。&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;2. 再将&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;map_strategy_weights 放到 map_ti_strategy_weights[0] 中。&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;map_ti_strategy_weights 维护的是每个时间点 ti 上的所有策略权重数据。&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;再将&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;map_strategy_weights 赋值给 map_strategy_tvr_adjust_weights 作为初始值。&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;4. * 计算每只股票的权重 weight： 【这个weight好像没有用到，废弃代码？】&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;4.1 遍历所有策略名&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;4.2 从&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;map_strategy_weights[策略名]&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;得到昨天该策略的所有股票权重&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;4.3 从 old_strategy_weights[&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;策略名&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;] 得到这个策略的旧权重&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;4.4 以上两者相乘，得到这个策略引入的股票实际权重&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;4.5 将各个策略下的股票权重进行累加，得到产品最终的个股权重&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;5. 计算该产品每个股票的昨日持仓手数 prev_volumes ，放到 map_ti_volumes[0] 中。&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;map_ti_volumes 维护了 每个 ti 各个股票的持仓手数情况。&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;6. 计算每个策略的个股归一化权重 map_strategy_normalized_weight，&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;map_strategy_normalized_weight[策略名] 是一个数组，维护了这个策略经过归一化计算的当前各个股票的权重。&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;7. 使用昨日实际持仓&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;prev_volumes&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp; 和&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;map_strategy_normalized_weight 计算得到各个策略初始化底仓 ：&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;7.1 对于一个股票，将各个策略在这个股票上的归一化权重进行排序。&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;7.2 根据排序后的权重由大到小逐个计算各策略在这个股票上的初始仓位。&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;7.3 第一轮计算，每个策略分配权重 = （&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;待分配仓位 * 归一化权重&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;）向下取整到100的整数倍，每次都会更新还剩余仓位&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;7.4 如果还剩余仓位，进行第二轮计算，此时按照（待分配仓位*归一化权重）向上取整到100的整数倍处理，但是如果分配超了，那么按照实际的 pre volume 差值进行补齐，从而保证一定不会超过昨日持仓。&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;8. 如果当前配置需要减仓，那么使用需要减仓的手数 volume 和 hedge_volume 算出减仓后的比例系数 rate，从而得到新的目标仓位 target_volumes。然后使用&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;target_volumes 和归一化权重重新计算初始底仓，同时根据 ti 计算得到每个 ti 的均匀减仓数量，维护到 map_ti_sub_volumes 中。&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;9. 将初始化的持仓 map_strategy_init_volumes 缓存到初始化理论持仓 map_strategy_init_theory_volumes 中。&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;10. 如果今天需要调权，那么使用&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;map_strategy_init_theory_volumes&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;进一步结合调权进行计算：&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;* 如果有子策略调权，那么这部分的调仓不能那个在初始化仓位的时候进行调整，而应该在调权的时点再做调整，所以这部分需要分离出来。&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;10.1 遍历所有策略。对于每一个策略，计算得到这个策略的新权重-旧权重的差值 delta&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;10.2 如果 delta 为负数（即新权重小于旧权重）：&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;10.2.1 将 |delta| 累加到 ProductConfig 的 total_adjust_weight 中&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;10.2.2 计算 冻结比例 = |delta| / 旧权重，冻结量= 冻结比例 *&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;map_strategy_init_theory_volumes&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;[策略][ii]&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;10.2.3 累加并维护这只票的总冻结量到 adjust_weight_locked_volumes[ii] 中&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;10.2.4 计算 未冻结量 = (1-冻结比例)&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;*&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;map_strategy_init_theory_volumes&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;[策略][ii]&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;10.2.5 更新理论初始持仓&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;map_strategy_init_theory_volumes&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;[策略][ii] 为未冻结量&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;11. 将计算得到的理论初始持仓维护到 map_ti_adjust_theory_volumes[0] 中&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;12. 结合当前 建仓/清仓/加仓/减仓 逻辑检查前日持仓是否非0&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;13. 输出初始化持仓明细&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;14. 如果是清仓，直接按照 减全仓 的方式计算出 map_ti_clear_volumes，表示每个&amp;nbsp;ti&amp;nbsp;的清仓量&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;15.&amp;nbsp;启动线程，执行 ThreadFunc&amp;nbsp;函数，线程维护到&amp;nbsp;adjust_thread&amp;nbsp;成员中。&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="520" y="1640" width="680" height="670" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-42" value="&lt;div&gt;ProductConfig 的初始化：&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;ProductConfig&lt;/span&gt;::Init()&lt;/div&gt;&lt;div&gt;1. 获取默认的配置对象&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;DefaultProductConfig&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;2. 根据配置文件&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;product id&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;设置 产品ID&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3.&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;根据配置文件 unistrategy 设置大策略名&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;4. 将&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;product id 和&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;unistrategy&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;拼接设置为 config_id&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;5. 根据配置文件 hedge_name 字段设置对标指数名称，如果没有则使用默认&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;配置对象的&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;对标指数&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;6. 根据配置文件 leverage 字段设置杠杆系数，如果没有则使用默认&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;配置对象的&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;杠杆系数&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;7. 根据配置文件&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;hedge_volume&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;设置持仓&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;8. 根据配置文件&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;addition_volume&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;设置持仓加法系数&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;9. 根据配置文件&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;multiply_volume&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;设置持仓乘法系数&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255)); background-color: transparent;&quot;&gt;10.&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;hedge_volume&amp;nbsp; = （&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;hedge_volume&amp;nbsp; +&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;addition_volume&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;）*&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;multiply_volume&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;11. 根据配置文件 output_if_not_ok 设置输出标志位&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;12. 根据配置文件中的 sub_strategies 设置子策略的新旧权重，以 { 策略名: 新权重 } 和&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;{ 策略名: 旧权重 }&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;的形式分别维护到 new_strategy_weights 和 old_strategy_weights 中&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;13. 使用&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;new_strategy_weights&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp; 和&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;old_strategy_weights&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp; 检查权重之和是否为1&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;14. 将&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;old_strategy_weights&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp; 中的策略名都放入 strategy_list 中&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;15. 然后根据&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;strategy_list 遍历当前依赖的策略名，通过 StrategyMgr 查询得到各个策略的更新 ti，然后将这些 ti 使用 set 进行去重和排序后放入 all_ti_triggers 中&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;16. 根据对标指数名称 hedge_name 查询出对标指数代码并设置到 hedge_code&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;17. 根据配置文件 requests 设置产品请求：&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;17.1 请求可选，包括：清仓/建仓/加仓/减仓/特殊调仓 中的至多一种。如果请求字段为空就是默认的调仓。&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;17.2 清仓处理：根据配置中的 clear_config 字段设置 ClearConfig 对象&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;17.3 建仓处理：根据配置中的 create_config 字段设置 CreateConfig 对象&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;17.4 建仓处理：根据配置中的 sub_config 字段设置 SubConfig 对象&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;17.5 建仓处理：根据配置中的 add_config 字段设置 AddConfig 对象&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;17.6 特殊调仓处理：根据配置中的 special_adjust_config 字段设置 SpecialAdjustConfig 对象&lt;/div&gt;&lt;div&gt;18. 根据配置文件的 adjust_weight_time，转换为对应的 ti 并设置到 adjust_weight_ti 中&lt;/div&gt;&lt;div&gt;19. 使用&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;new_strategy_weights&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;和&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;old_strategy_weights&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;检查所有策略的新旧权重，如果有变化，那么意味这个产品需要调整权重，那么调权重的时点&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;adjust_weight_ti&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp; 必须大于1&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;20. 使用&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;all_ti_triggers&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;检查调整权重的时点&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;adjust_weight_ti&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;必须在子策略的触发时间点列表中&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="520" y="1140" width="680" height="480" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-44" value="product 的配置文件结构注：default 部分可以认为是所有product 缺省的，下面的 product_config 是每个产品自己的属性定义" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="-160" y="580" width="160" height="120" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-45" value="Product::Thre&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;adFunc&lt;/span&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;while true 持续从 ti_queue 中取出 ti，然后执行 AdjustProduct 函数&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="520" y="2340" width="680" height="100" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-46" value="Product::AdjustProduct&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1. 如果产品配置为清仓，走清仓逻辑 (Product::ClearPosition)&lt;/div&gt;&lt;div&gt;2. 如果产品配置为建仓，走建仓逻辑 (Product::CreatePosition)&lt;/div&gt;&lt;div&gt;3. 如果产品配置为特殊调仓，走特殊调仓逻辑 (Product::SpecialAdjustPosition)&lt;/div&gt;&lt;div&gt;4. 否则（需要调仓/加仓/减仓）：&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;4.1 找到在该 ti 所有需要调仓的子策略，放到 strategy_list 中&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;4.2 检查这些子策略当前 ti 的信号是否已经就绪。如果没有就绪，则返回。 (Product::WaitSignals)&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;4.3 从 SignalReceiver 中读取该策略当前 ti 的 signal（股票权重），更新到 map_strategy_weights[策略] 中，然后再将&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;map_strategy_weights 更新到 map_ti_strategy_weights[ti] 中。（Product::UpdateSignals&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;）&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;4.4 从行情模块 MD 中取出当前时间（上一个时间点）的价格。（MD::GetTi1Price&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;）&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;4.5 如果当前是调仓，那么走调仓逻辑 (Product::&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;AdjustPosition&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;4.6 如果当前是加仓，那么走加仓逻辑 (&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;Product::&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;AddPosition)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;4.7 如果当前是减仓，那么走减仓逻辑 (&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;Product::&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;SubPosition&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;4.8 如果当前需要调整权重，走调权逻辑 (Product::AdjustWeight)&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;4.9 计算锁定金额，更新到 map_ti_product_data 中，这个数据维护了每个 ti 的 product 相关的参数属性&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="520" y="2560" width="680" height="920" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-47" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;fontColor=#333333;strokeColor=#666666;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="-440" y="3810" width="800" height="310" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-48" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" edge="1" parent="1" source="i-nkXKOmJGmnzbzkcPUM-49" target="i-nkXKOmJGmnzbzkcPUM-51">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-49" value="收到信号" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-40" y="3850" width="360" height="40" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-51" value="OnNewSignalData" style="rounded=0;whiteSpace=wrap;html=1;align=center;verticalAlign=middle;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="-40" y="3930" width="360" height="50" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-59" value="&lt;span style=&quot;color: rgb(51, 51, 51); text-align: left;&quot;&gt;&lt;font style=&quot;font-size: 16px;&quot;&gt;接收信号流程&lt;/font&gt;&lt;/span&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="-410" y="3830" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-60" value="&lt;div&gt;SignalReceiver::OnNewSignalSData&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1. data 解析成 AlphaSignalValue 结构 （包含日期、时间戳/7500个票的信号值）&lt;/div&gt;&lt;div&gt;2. 根据信号时间得到这个时间点的 ti&lt;/div&gt;&lt;div&gt;&lt;div&gt;3. 查找 signal name 是否是有效的 strategy 名称，如果该 strategy 不存在或对应的策略更新 ti 为空，则直接返回&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;4. 查找这个 strategy name （即 singal_name） 对应的 signals 数据，如果没有这个 key，或者 signals[策略] 对应的 section 数据中没有这个 ti，那么表示是新来的信号，日志打印&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;5. 将这个信号 set 到对应策略当前ti的 SectionMgr 中。&lt;/span&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="520" y="3800" width="680" height="320" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-61" value="signal receiver&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="-320" y="4200" width="320" height="400" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-62" value="signals" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#f5f5f5;fontColor=#333333;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="-300" y="4230" width="270" height="210" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-94" value="SectionMgr" style="rounded=0;whiteSpace=wrap;html=1;verticalAlign=bottom;" vertex="1" parent="1">
          <mxGeometry x="-210" y="4240" width="140" height="140" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-67" value="ti0" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="-210" y="4280" width="30" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-68" value="ti1" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="-210" y="4300" width="30" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-69" value="ti2" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="-210" y="4320" width="30" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-70" value="..." style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="-210" y="4340" width="30" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-71" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-180" y="4280" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-72" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-160" y="4280" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-73" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-140" y="4280" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-74" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-120" y="4280" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-75" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-100" y="4280" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-76" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-180" y="4300" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-77" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-160" y="4300" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-78" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-140" y="4300" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-79" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-120" y="4300" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-80" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-100" y="4300" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-81" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-180" y="4320" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-82" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-160" y="4320" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-83" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-140" y="4320" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-84" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-120" y="4320" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-85" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-100" y="4320" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-86" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-180" y="4340" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-87" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-160" y="4340" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-88" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-140" y="4340" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-89" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-120" y="4340" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-90" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-100" y="4340" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-93" value="7500 股票" style="shape=loopLimit;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="-180" y="4250" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-63" value="策略1" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="-280" y="4280" width="70" height="80" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-95" value="Product::AdjustPosition&lt;div&gt;1. 使用 ti 计算 time 时间戳，如果是 092500 则等待 60 秒&lt;/div&gt;&lt;div&gt;2. 使用配置的 hedge volume 和最新指数价格计算 hedge amount&lt;/div&gt;&lt;div&gt;3. 筛选出当前需要调仓的策略&lt;/div&gt;&lt;div&gt;4. 拿到上一个 ti 的各策略的理论持仓&lt;/div&gt;&lt;div&gt;5. 拿到上一个截面的价格 prices&lt;/div&gt;&lt;div&gt;6. 对上一个&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;ti 的各策略的理论持仓求和得到各支票的 volume&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;7. sum(&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;prices[] *&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;volume[]&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;) 得到总的 before_amount 即上一个时点的市值&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;8. 执行调仓 Product::UpdatePosition&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;9. 将本次调仓结果存入 map_ti_adjust_theory_volumes[ti] 中&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;10. 得到调仓后的理论仓位数组 theory_volumes&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;11. 对理论仓位数组进行 rounding 处理 （整百股）得到实际 volume&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;12. 分别使用&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;theory_volumes 和&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;volume 计算得到理论和实际市值&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;13. csv 记录&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;14. 将实际市值、理论市值、对标指数市值等信息更新到 map_ti_product_data 中&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;15. 计算得到 buy-sell 数据输出到 csv 文件 （Product::CountBuyAndSell）&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="1240" y="2560" width="680" height="360" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-96" value="hedge volume 就是拿来用最新的指数价格去计算计算对标的指数市值的" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="1260" y="2450" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-97" value="&lt;div&gt;&lt;div&gt;Product::CountBuyAndSell&lt;/div&gt;&lt;/div&gt;&lt;div&gt;传入 ti， prices，调仓前各个策略的 volumes，调仓后各个策略的 volumes，输出 Buy-Sell 数据到 csv&lt;/div&gt;&lt;div&gt;1. 使用调仓前后的 volumes 和 prices 分别计算出调仓前后的 amounts，记录到csv&lt;/div&gt;&lt;div&gt;2. 使用 调仓前[策略][ii]的volume -&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;调仓后[策略][ii]的volume，得到该策略这支股票 volume 变化量的 delta，delta&amp;gt;0表示需要买入，delta&amp;lt;0 表示需要卖出&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;3. 根据 delta 大于或小于0，更新 map_ti_product_data 的 buy_volume，buy_amount，sell_volume，sell_amount。&lt;/span&gt;&lt;/div&gt;&lt;div&gt;4. 更新 [策略][ii] 的 delta volume 和 delta amount&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="1960" y="2840" width="680" height="240" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-98" value="&lt;div&gt;&lt;div&gt;Product::UpdatePosition&lt;/div&gt;&lt;/div&gt;&lt;div&gt;1. 获取上一个 ti 的价格到 prices&lt;/div&gt;&lt;div&gt;2. 遍历当前需要调仓的 strategy_list：&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;2.1 子策略权重 = min(子策略新权重， 子策略旧权重)&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;2.2 子策略应有市值 strategy_hedge_amount = 对标指数市值 * 子策略权重&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;2.3 使用（尚未更新的）当前策略理论&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;[ii]&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;手数* prices&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;[ii]&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;，累加得到调仓前的市值 strategy_before_amount&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;2.4 拿到当前子策略的股票权重 stock_w&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;eights&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;2.5 拿到&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;当前子策略&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;上一次调仓时的股票权重 last_weights&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;2.6 使用&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;last_weights 和&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;stock_w&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;eights 计算本次调仓的换手率（就是权重差异绝对值求和的值）&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;2.7 如果换手率 小于 0.01，则不调仓&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;2.8 否则进行调仓处理：&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;2.8.1 将 map_strategy_tvr_adjust_weights 更新为当前的&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;stock_w&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;eights&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;2.8.2 将外部传入的理论仓位 map_strategy_theory_volumes&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;[策略]&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;先清零 (7500, 0)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;2.8.3&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;遍历7500支票:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;2.8.3.1 该股票理论手数 volume_ii =&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;子策略应有市值 * 权重 / 该股票当前价格&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;2.8.3.2 更新策略理论手数&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;map_strategy_theory_volumes[策略][ii] 为&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;volume_ii&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="1960" y="2420" width="680" height="400" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-100" value="&lt;span style=&quot;color: rgb(0, 0, 0); font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: center; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; float: none; display: inline !important;&quot;&gt;为什么是 min ？&lt;/span&gt;" style="shape=step;perimeter=stepPerimeter;whiteSpace=wrap;html=1;fixedSize=1;" vertex="1" parent="1">
          <mxGeometry x="1740" y="2430" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-101" value="&lt;span style=&quot;color: rgb(0, 0, 0); font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: center; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; float: none; display: inline !important;&quot;&gt;所以这里使用对标指数的市值和权重&lt;/span&gt;&lt;div&gt;&lt;span style=&quot;color: rgb(0, 0, 0); font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: center; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; float: none; display: inline !important;&quot;&gt;来计算得到一个子策略该有的市值&lt;/span&gt;&lt;/div&gt;" style="shape=step;perimeter=stepPerimeter;whiteSpace=wrap;html=1;fixedSize=1;" vertex="1" parent="1">
          <mxGeometry x="1620" y="2480" width="320" height="40" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-102" value="这个换手率有可能大于1，比如可能等于2，对吗" style="shape=step;perimeter=stepPerimeter;whiteSpace=wrap;html=1;fixedSize=1;flipV=1;flipH=1;" vertex="1" parent="1">
          <mxGeometry x="2530" y="2520" width="320" height="50" as="geometry" />
        </mxCell>
        <mxCell id="i-nkXKOmJGmnzbzkcPUM-103" value="此处理论手数不能取整" style="shape=step;perimeter=stepPerimeter;whiteSpace=wrap;html=1;fixedSize=1;flipV=1;flipH=1;" vertex="1" parent="1">
          <mxGeometry x="2520" y="2620" width="320" height="50" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
